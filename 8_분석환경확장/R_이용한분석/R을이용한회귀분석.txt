1. R과 R-studion 다운로드
https://www.r-project.org/
https://rstudio.com/

2. R 파일럿 실행 1단계 : 분석 데이터셋 생성 
1) CarMaster2Income.txt 파일을 /home/pilot-pjt/working에 업로드 (FileZilla 이용)

2) Hue의 Hive쿼리에서 다음 쿼리들 입력
CREATE EXTERNAL TABLE SmartCar_Master2Income (
car_number string,
sex string,
age string,
marriage string,
region string,
job string,
car_capacity int,
car_year string,
car_model string,
income int
)
row format delimited
fields terminated by '|'
stored as textfile
tblproperties ("skip.header.line.count"="1");

LOAD DATA LOCAL INPATH '/home/pilot-pjt/working/CarMaster2Income.txt' OVERWRITE INTO TABLE SmartCar_Master2Income;

Select 
    car_number, 
    car_capacity,
    income
from SmartCar_Master2Income;

3. hive 클라이언트 라이브러리 구성

1) 디렉터리 생성
D://hiveJar
D://hadoopJar

2) 각 디렉터리에 드라이버 파일 옮김
D://hiveJar에 아래 파일 넣음
/opt/cloudera/parcels/CDH/jars/
hive-jdbc-2.1.1-cdh6.3.2.jars
hive-service-2.1.1-cdh6.3.2.jars
httpclient-4.5.3.jar
httpcore-4.4.6.jar
hive-jdbc-2.1.1.-cdh6.3.2-standalone.jar

D://hadoopJar에 아래 파일 넣음
/opt/cloudera/parcels/CDH/jars/
hadoop-common-3.0.0-cdh6.3.2.jar
libthrift-0.9.3.jar
hadoop-client-3.0.0-cdh6.3.2.jar

4. R에서 하이브 데이터 로드 

1) 패키지 설치
> install.packages("DBI")
> install.packages("rJava")
> install.packages("RJDBC")
> install.packages("log4r")

2) 라이브러리 로드
> library("DBI")
> library("rJava")
> library("RJDBC")

> hive.class.path = list.files(path=c("D://hiveJar"), pattern="jar", full.names=T);
> hadoop.lib.path = list.files(path=c("D://hadoopJar"), pattern="jar", full.names=T);
> hadoop.class.path = list.files(path=c("D://hadoopJar"), pattern="jar", full.names=T);
> class.path = c(hive.class.path, hadoop.lib.path, hadoop.class.path);
> .jinit(classpath=class.path)



> drv <- JDBC("org.apache.hive.jdbc.HiveDriver", "D://hiveJar/hive-jdbc-2.1.1-cdh6.3.2.jar",identifier.quote="`")
> conn <- dbConnect(drv, "jdbc:hive2://server02.hadoop.com:10000/default", "hive2","WtobaGNQtC")



> dbListTables(conn);


> data <- dbGetQuery(conn, "select * from smartcar_master2income")
> View(data)

5. 데이터 탐색 및 회귀모델 생성

> hist(data$smartcar_master2income.income)
> boxplot(data$smartcar_master2income.income)
> qqnorm(data$smartcar_master2income.income)
> qqline(data$smartcar_master2income.incom)



> model <- lm(data$smartcar_master2income.income~smartcar_master2income.car_capacity,data=data)
> summary(model)


> test_data <- read.csv("D://test_data/CarMaster2Income_Test.txt", sep="|", header=T, encoding = "UTF-8")
> predict(model, test_data, interval = "prediction")

